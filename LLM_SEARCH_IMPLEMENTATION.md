# LLM 기반 검색 기능 구현 가이드

## 구현된 기능

### 1. 자연어 검색 입력
**파일**: `apps/frontend/app/search/page.tsx`

사용자가 검색창에 자연어로 분실물을 설명하면, 이 쿼리가 `/results` 페이지로 전달됩니다.

**예시 검색 쿼리**:
- "하늘색 무늬 케이스의 아이폰 12 Pro"
- "검은색 고급 지갑 MCM 브랜드"
- "무선 헤드셋 Sony 블랙"

### 2. 백엔드 유사도 점수 계산
**파일**: `apps/api/app/routers/search.py`

#### 검색 프로세스:
1. **후보 아이템 수집**: DB에서 보관 중인 모든 분실물을 가져옴 (`status = STORED`)
2. **키워드 추출**: 검색 쿼리를 단어 단위로 분리하여 키워드 추출
3. **유사도 점수 계산**: 각 아이템에 대해 다음 기준으로 점수 계산:
   - **제목 완전 일치** (40점)
   - **제목 키워드 일치** (30점)
   - **카테고리 일치** (15점)
   - **브랜드 일치** (15점)
   - **색상 일치** (15점)
   - **설명 키워드 일치** (10점)
   - **보관 위치 일치** (5점)
4. **Top 5 선정**: 점수가 10점 이상인 아이템만 저장하고, 점수 높은 순으로 상위 5개만 반환
5. **매칭 근거 생성**: 각 아이템이 선택된 이유를 간략하게 설명

#### 응답 형식:
```json
{
  "results": [
    {
      "id": 1,
      "name": "아이폰 12 Pro",
      "brand": "Apple",
      "color": "실버",
      "category": "전자기기",
      "stored_place": "공대 1호관 안내데스크",
      "photos": [...],
      "score": 85.5,
      "reason": "제목 키워드 일치 (아이폰, 12, pro) | 브랜드 일치 (apple) | 색상 일치 (실버)"
    },
    ...
  ],
  "query": "하늘색 무늬 케이스의 아이폰 12 Pro"
}
```

### 3. 결과 페이지 점수 표시
**파일**: `apps/frontend/app/results/page.tsx`

#### 표시되는 정보:
- **유사도 점수**: 각 분실물 카드 우측 상단에 점수 표시 (예: "85점")
- **매칭 근거**: 카드 하단에 간략한 설명 표시 (예: "제목 키워드 일치 (아이폰) | 브랜드 일치 (apple)")
- **정렬 기능**: "유사도 점수순" 또는 "최신순" 선택 가능

#### UI 구성:
```tsx
<article className="lf-card">
  {/* 사진 */}
  <div className="lf-media">...</div>
  
  {/* 정보 */}
  <div className="lf-cardBody">
    <div className="lf-cardHead">
      <h3>{item.name}</h3>
      <span className="lf-score">{item.score}점</span> {/* 점수 */}
    </div>
    
    <div className="lf-chips">
      {/* 브랜드, 색상, 카테고리, 보관 위치 */}
    </div>
    
    {/* 매칭 근거 */}
    <p className="lf-reason">
      <span className="lf-reasonLabel">매칭 근거</span>
      <span>{item.reason}</span>
    </p>
  </div>
</article>
```

## 점수 계산 로직

### 가중치 체계:
1. **제목 완전 일치** (40점) - 쿼리가 아이템 이름에 정확히 포함
2. **제목 키워드 일치** (30점) - 쿼리의 키워드가 이름에 포함
3. **카테고리 일치** (15점) - 키워드가 카테고리와 일치
4. **브랜드 일치** (15점) - 키워드가 브랜드와 일치
5. **색상 일치** (15점) - 키워드가 색상과 일치
6. **설명 키워드 일치** (10점) - 키워드가 특성/기능 설명에 포함
7. **보관 위치 일치** (5점) - 키워드가 보관 위치와 일치

### 점수 범위:
- **최소**: 10점 이상인 아이템만 결과에 포함
- **최대**: 100점

### 예시:
**검색 쿼리**: "하늘색 무늬 케이스의 아이폰 12 Pro"

**매칭된 아이템**:
1. **아이폰 12 Pro 실버** (90점)
   - 제목 키워드 일치: "아이폰", "12", "pro" (+30)
   - 브랜드 일치: "Apple" (+15)
   - 설명 키워드: "케이스" (+10)
   - 근거: "제목 키워드 일치 (아이폰, 12, pro) | 브랜드 일치 (apple)"

2. **아이폰 12 Pro 골드** (70점)
   - 제목 키워드 일치: "아이폰", "12", "pro" (+30)
   - 브랜드 일치: "Apple" (+15)
   - 근거: "제목 키워드 일치 (아이폰, 12, pro) | 브랜드 일치 (apple)"

3. **아이폰 11 Pro 실버** (60점)
   - 제목 키워드 일치: "아이폰", "pro" (+30)
   - 브랜드 일치: "Apple" (+15)
   - 근거: "제목 키워드 일치 (아이폰, pro) | 브랜드 일치 (apple)"

## 추후 개선 사항

### 현재 구현 (규칙 기반):
- 키워드 매칭 기반 점수 계산
- 간단하고 빠르지만 정확도 제한적

### 향후 LLM 통합:
1. **임베딩 기반 유사도**:
   - 검색 쿼리를 벡터로 변환
   - 각 아이템 설명도 벡터로 변환
   - 코사인 유사도 계산

2. **생성형 AI 활용**:
   - LLM이 쿼리를 자연어로 분석
   - 각 아이템의 매칭 이유를 자동 생성
   - 더 맥락적이고 자연스러운 근거 설명

3. **하이브리드 접근**:
   - 규칙 기반으로 후보 선별 (빠름)
   - LLM으로 상위 후보 재순위화 (정확함)

## API 엔드포인트

### 검색 API
**URL**: `GET /search?q={query}`

**요청 예시**:
```bash
curl http://localhost:8000/search?q=하늘색%20무늬%20케이스의%20아이폰%2012%20Pro
```

**응답 예시**:
```json
{
  "results": [
    {
      "id": 1,
      "name": "아이폰 12 Pro",
      "brand": "Apple",
      "color": "실버",
      "category": "전자기기",
      "stored_place": "공대 1호관 안내데스크",
      "thumb_url": "data:image/base64,...",
      "photos": [...],
      "score": 85.5,
      "reason": "제목 키워드 일치 (아이폰, 12, pro) | 브랜드 일치 (apple)"
    }
  ],
  "query": "하늘색 무늬 케이스의 아이폰 12 Pro"
}
```

## 테스트 방법

1. **검색 실행**:
   - 검색 페이지에서 자연어 쿼리 입력
   - "하늘색 무늬 케이스의 아이폰 12 Pro" 검색

2. **결과 확인**:
   - 결과 페이지에서 Top 5 분실물 확인
   - 각 분실물의 점수 확인
   - 매칭 근거 확인

3. **정렬 테스트**:
   - "유사도 점수순" 선택
   - "최신순" 선택

4. **상세 보기**:
   - 각 분실물 카드 클릭
   - 상세 정보 페이지 확인

## 파일 변경 사항

### 백엔드
- `apps/api/app/routers/search.py`: 유사도 점수 계산 로직 추가

### 프론트엔드
- `apps/frontend/app/results/page.tsx`: 점수 및 근거 표시 추가
- `apps/frontend/styles/globals.css`: 점수 및 근거 스타일 (이미 존재)

### 스타일
점수 표시: `.lf-score` - 우측 상단 파란색 뱃지
근거 표시: `.lf-reason` - 하단 회색 설명

